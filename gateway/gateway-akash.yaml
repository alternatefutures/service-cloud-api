---
# Caddy SSL Gateway for Akash Network
# Provides Let's Encrypt SSL termination for custom domains
version: "2.0"

services:
  gateway:
    image: caddy:2-alpine
    expose:
      # HTTP - for Let's Encrypt ACME challenge and redirect
      # Using TCP proto to bypass HTTP ingress and get direct port access
      - port: 80
        as: 80
        proto: tcp
        to:
          - global: true
      # HTTPS - SSL termination with Let's Encrypt certs
      - port: 443
        as: 443
        proto: tcp
        to:
          - global: true
    env:
      # Backend services (Akash ingress URLs)
      - API_BACKEND=https://cjrdmusuql9e34bevi8mjgj8pg.ingress.europlots.com
      - AUTH_BACKEND=https://uilm2birnle5b7ffcqvsgpolc4.ingress.europlots.com
      # Let's Encrypt email
      - ACME_EMAIL=admin@alternatefutures.ai
    command:
      - sh
      - -c
      - |
        cat > /etc/caddy/Caddyfile << 'CADDYFILE'
        {
            email {$ACME_EMAIL}
            # Uncomment for testing with Let's Encrypt staging
            # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
        }

        api.alternatefutures.ai {
            reverse_proxy {$API_BACKEND} {
                header_up Host api.alternatefutures.ai
                header_up X-Real-IP {remote_host}
                header_up X-Forwarded-For {remote_host}
                header_up X-Forwarded-Proto https
                transport http {
                    tls
                    tls_insecure_skip_verify
                }
            }
            header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains"
                X-Content-Type-Options "nosniff"
            }
        }

        auth.alternatefutures.ai {
            reverse_proxy {$AUTH_BACKEND} {
                header_up Host auth.alternatefutures.ai
                header_up X-Real-IP {remote_host}
                header_up X-Forwarded-For {remote_host}
                header_up X-Forwarded-Proto https
                transport http {
                    tls
                    tls_insecure_skip_verify
                }
            }
            header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains"
                X-Content-Type-Options "nosniff"
            }
        }
        CADDYFILE

        echo "Starting Caddy gateway..."
        caddy run --config /etc/caddy/Caddyfile

profiles:
  compute:
    gateway:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 256Mi
        storage:
          - size: 1Gi

  placement:
    akash:
      attributes:
        host: akash
      signedBy:
        anyOf:
          - "akash1365yvmc4s7awdyj3n2sav7xfx76adc6dnmlx63"
      pricing:
        gateway:
          denom: uakt
          amount: 500

deployment:
  gateway:
    akash:
      profile: gateway
      count: 1
