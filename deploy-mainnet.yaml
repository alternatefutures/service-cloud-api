---
# Akash SDL (Stack Definition Language) for Alternate Futures Backend
# This deploys the GraphQL API + YugabyteDB (3-node cluster) + Self-Hosted IPFS to Akash Network
#
# YugabyteDB replaces both PostgreSQL and Redis with:
# - Distributed SQL database (PostgreSQL-compatible)
# - Built-in high availability (survives 1 node failure)
# - Automatic replication (3x by default)
# - Open source (Apache 2.0)

version: "2.0"

services:
  # YugabyteDB Node 1 - Master + TServer
  # Primary node that other nodes join to
  yb-node-1:
    image: yugabytedb/yugabyte:2.20.1.0-b2
    command:
      - "/home/yugabyte/bin/yugabyted"
      - "start"
      - "--advertise_address=yb-node-1"
      - "--master_flags=replication_factor=3"
      - "--tserver_flags=ysql_enable_auth=true"
      - "--daemon=false"
    env:
      - YSQL_USER=yugabyte
      - YSQL_PASSWORD=your_secure_password_here_change_this
      - YSQL_DB=alternatefutures
    expose:
      # YSQL (PostgreSQL-compatible API) - for app connections
      - port: 5433
        as: 5433
        to:
          - service: api
      # Master RPC - for cluster coordination
      - port: 7100
        as: 7100
        to:
          - service: yb-node-2
          - service: yb-node-3
      # TServer RPC - for data replication
      - port: 9100
        as: 9100
        to:
          - service: yb-node-2
          - service: yb-node-3
      # Admin UI - web interface for monitoring
      - port: 15000
        as: 15000
        to:
          - global: true
        accept:
          - yb.alternatefutures.ai
    params:
      storage:
        data:
          mount: /mnt/disk0
          readOnly: false

  # YugabyteDB Node 2 - Master + TServer
  # Joins node 1 to form HA cluster
  yb-node-2:
    image: yugabytedb/yugabyte:2.20.1.0-b2
    command:
      - "/home/yugabyte/bin/yugabyted"
      - "start"
      - "--advertise_address=yb-node-2"
      - "--join=yb-node-1"
      - "--master_flags=replication_factor=3"
      - "--tserver_flags=ysql_enable_auth=true"
      - "--daemon=false"
    env:
      - YSQL_USER=yugabyte
      - YSQL_PASSWORD=your_secure_password_here_change_this
      - YSQL_DB=alternatefutures
    expose:
      # YSQL - for app connections
      - port: 5433
        as: 5433
        to:
          - service: api
      # Master RPC
      - port: 7100
        as: 7100
        to:
          - service: yb-node-1
          - service: yb-node-3
      # TServer RPC
      - port: 9100
        as: 9100
        to:
          - service: yb-node-1
          - service: yb-node-3
    params:
      storage:
        data:
          mount: /mnt/disk0
          readOnly: false

  # YugabyteDB Node 3 - Master + TServer
  # Third node completes the HA setup (tolerates 1 node failure)
  yb-node-3:
    image: yugabytedb/yugabyte:2.20.1.0-b2
    command:
      - "/home/yugabyte/bin/yugabyted"
      - "start"
      - "--advertise_address=yb-node-3"
      - "--join=yb-node-1"
      - "--master_flags=replication_factor=3"
      - "--tserver_flags=ysql_enable_auth=true"
      - "--daemon=false"
    env:
      - YSQL_USER=yugabyte
      - YSQL_PASSWORD=your_secure_password_here_change_this
      - YSQL_DB=alternatefutures
    expose:
      # YSQL - for app connections
      - port: 5433
        as: 5433
        to:
          - service: api
      # Master RPC
      - port: 7100
        as: 7100
        to:
          - service: yb-node-1
          - service: yb-node-2
      # TServer RPC
      - port: 9100
        as: 9100
        to:
          - service: yb-node-1
          - service: yb-node-2
    params:
      storage:
        data:
          mount: /mnt/disk0
          readOnly: false

  # IPFS Node (Kubo) - Self-hosted decentralized storage
  ipfs:
    image: ipfs/kubo:latest
    env:
      - IPFS_PROFILE=server
      - IPFS_PATH=/data/ipfs
    expose:
      # API port (for API service to connect)
      - port: 5001
        as: 5001
        to:
          - service: api
      # Gateway port (public access to IPFS content)
      - port: 8080
        as: 8080
        to:
          - global: true
        accept:
          - ipfs.alternatefutures.ai
      # Swarm port (P2P connections to IPFS network)
      - port: 4001
        as: 4001
        proto: tcp
        to:
          - global: true
    params:
      storage:
        data:
          mount: /data/ipfs
          readOnly: false

  # GraphQL API Service
  # Connects to YugabyteDB (PostgreSQL-compatible) and IPFS
  api:
    image: ghcr.io/alternatefutures/service-cloud-api:latest
    env:
      # Database - YugabyteDB (PostgreSQL-compatible on port 5433)
      # Can connect to any of the 3 nodes (automatic failover)
      - DATABASE_URL=postgresql://yugabyte:your_secure_password_here_change_this@yb-node-1:5433/alternatefutures

      # App Config
      - NODE_ENV=production
      - PORT=4000

      # JWT Secret (CHANGE THIS!)
      - JWT_SECRET=your_jwt_secret_min_32_chars_please_change_this_in_production

      # Email (Resend)
      - RESEND_API_KEY=your_resend_api_key

      # Storage - Self-Hosted IPFS (Required)
      - IPFS_API_URL=http://ipfs:5001
      - IPFS_GATEWAY_URL=https://ipfs.alternatefutures.ai

      # Storage - Arweave (Optional)
      - ARWEAVE_WALLET=your_arweave_wallet

      # Storage - Filecoin
      - LIGHTHOUSE_API_KEY=your_lighthouse_api_key

      # Optional: Analytics
      - SENTRY_DSN=your_sentry_dsn

    expose:
      - port: 4000
        as: 80
        to:
          - global: true
        accept:
          - api.alternatefutures.ai
    depends_on:
      - yb-node-1
      - yb-node-2
      - yb-node-3
      - ipfs

profiles:
  compute:
    # YugabyteDB Node 1 (Master + TServer)
    # Higher resources for distributed database
    yb-node-1:
      resources:
        cpu:
          units: 2.0
        memory:
          size: 4Gi
        storage:
          # 50Gi for database data + replication
          size: 50Gi

    # YugabyteDB Node 2 (Master + TServer)
    yb-node-2:
      resources:
        cpu:
          units: 2.0
        memory:
          size: 4Gi
        storage:
          size: 50Gi

    # YugabyteDB Node 3 (Master + TServer)
    yb-node-3:
      resources:
        cpu:
          units: 2.0
        memory:
          size: 4Gi
        storage:
          size: 50Gi

    # API Service
    api:
      resources:
        cpu:
          units: 1.0
        memory:
          size: 1Gi
        storage:
          size: 512Mi

    # IPFS Node
    ipfs:
      resources:
        cpu:
          units: 2.0
        memory:
          size: 4Gi
        storage:
          # Large storage for IPFS blocks and pinned content
          size: 100Gi

  placement:
    dcloud:
      pricing:
        # Mainnet-optimized pricing (~250 uakt/block = 108 AKT/month = $65/month)
        # Conservative bids to ensure provider acceptance
        yb-node-1:
          denom: uakt
          amount: 50
        yb-node-2:
          denom: uakt
          amount: 50
        yb-node-3:
          denom: uakt
          amount: 50
        api:
          denom: uakt
          amount: 30
        ipfs:
          denom: uakt
          amount: 70

deployment:
  yb-node-1:
    dcloud:
      profile: yb-node-1
      count: 1

  yb-node-2:
    dcloud:
      profile: yb-node-2
      count: 1

  yb-node-3:
    dcloud:
      profile: yb-node-3
      count: 1

  api:
    dcloud:
      profile: api
      count: 1

  ipfs:
    dcloud:
      profile: ipfs
      count: 1
