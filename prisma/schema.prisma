// Prisma Schema for AlternateFutures Platform
generator client {
  provider      = "prisma-client-js"
  engineType    = "binary"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATIONS & SERVICE REGISTRY (Workloads)
// ============================================

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

enum ServiceType {
  SITE
  FUNCTION
  VM
  DATABASE
  CRON
  BUCKET
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  username      String?  @unique
  walletAddress String?  @unique

  projects              Project[]
  organizationMemberships OrganizationMember[]
  createdServices       Service[]
  agents                Agent[]
  chats                 Chat[]
  messages              Message[]
  pinnedContent         PinnedContent[]
  storageSnapshots      StorageSnapshot[]
  customer              Customer?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
  @@index([walletAddress])
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  organizationId String?  @map("organization_id")

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  sites     Site[]
  functions AFFunction[]
  services  Service[]

  // Observability
  telemetryIngestions   TelemetryIngestion[]
  observabilitySettings ObservabilitySettings?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([slug])
}

// ============================================
// SITES & DEPLOYMENTS
// ============================================

model Site {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  serviceId   String?  @unique
  service     Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  deployments Deployment[]
  domains     Domain[]
  ipnsRecords IPNSRecord[]
  zones       Zone[]
  akashDeployments AkashDeployment[]
  phalaDeployments PhalaDeployment[]

  primaryDomainId String?
  primaryDomain   Domain? @relation("PrimaryDomain", fields: [primaryDomainId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([slug])
}

model Deployment {
  id          String           @id @default(cuid())
  cid         String
  status      DeploymentStatus @default(PENDING)
  storageType StorageType      @default(IPFS)

  siteId      String
  site        Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)

  pin         Pin?

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([siteId])
  @@index([cid])
  @@index([status])
}

enum DeploymentStatus {
  PENDING
  BUILDING
  UPLOADING
  SUCCESS
  FAILED
}

enum StorageType {
  IPFS
  ARWEAVE
  FILECOIN
}

// ============================================
// FUNCTIONS
// ============================================

model AFFunction {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  sourceCode          String?              @db.Text
  invokeUrl           String?
  routes              Json?
  status              FunctionStatus       @default(ACTIVE)

  projectId           String
  project             Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)

  serviceId           String?              @unique
  service             Service?             @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  siteId              String?

  currentDeploymentId String?              @unique
  currentDeployment   AFFunctionDeployment? @relation("CurrentDeployment", fields: [currentDeploymentId], references: [id])

  deployments         AFFunctionDeployment[] @relation("FunctionDeployments")
  akashDeployments    AkashDeployment[]
  phalaDeployments    PhalaDeployment[]
  agents              Agent[]

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([projectId])
  @@index([slug])
  @@index([status])
}

model AFFunctionDeployment {
  id              String         @id @default(cuid())
  cid             String
  blake3Hash      String?
  assetsCid       String?
  sgx             Boolean        @default(false)

  afFunctionId String
  afFunction   AFFunction  @relation("FunctionDeployments", fields: [afFunctionId], references: [id], onDelete: Cascade)

  currentFunction AFFunction? @relation("CurrentDeployment")

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([afFunctionId])
  @@index([cid])
}

enum FunctionStatus {
  ACTIVE
  INACTIVE
  DEPLOYING
  FAILED
}

model Organization {
  id        String   @id @default(cuid())
  slug      String?
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   OrganizationMember[]
  projects  Project[]

  @@index([slug])
}

model OrganizationMember {
  id             String           @id @default(cuid())
  organizationId String
  userId         String
  role           OrganizationRole @default(MEMBER)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

model Service {
  id              String      @id @default(cuid())
  type            ServiceType
  name            String
  slug            String
  projectId       String
  templateId      String?
  dockerImage     String?     // Custom Docker image (e.g. ghcr.io/org/app:v1)
  containerPort   Int?        // Port the container listens on (default: 80). Used in SDL generation.
  createdByUserId String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  project         Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdByUser   User?       @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  // One-to-one (subtype tables have the FK via serviceId)
  site            Site?
  afFunction      AFFunction?

  // Akash deployments for this service (can have multiple over time)
  akashDeployments AkashDeployment[]
  phalaDeployments PhalaDeployment[]

  @@unique([type, slug])
  @@index([projectId])
  @@index([createdByUserId])
}

// ============================================
// DOMAINS
// ============================================

model Domain {
  id          String       @id @default(cuid())
  hostname    String       @unique
  verified    Boolean      @default(false)
  domainType  DomainType   @default(WEB2)

  siteId      String
  site        Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)

  primarySite Site[]       @relation("PrimaryDomain")

  // DNS Verification
  txtVerificationToken    String?   // Token to verify via TXT record
  txtVerificationStatus   VerificationStatus @default(PENDING)
  dnsVerifiedAt           DateTime?

  // DNS Records for verification
  expectedCname           String?   // Expected CNAME value
  expectedARecord         String?   // Expected A record value

  // SSL Certificate
  sslStatus               SslStatus @default(NONE)
  sslCertificateId        String?   // Let's Encrypt cert ID
  sslIssuedAt             DateTime?
  sslExpiresAt            DateTime?
  sslAutoRenew            Boolean   @default(true)

  // Web3 Domain Integration
  arnsName                String?   // ArNS name for Arweave
  arnsTransactionId       String?   // Arweave transaction ID
  ensName                 String?   // ENS domain name
  ensContentHash          String?   // ENS content hash
  ipnsHash                String?   // IPNS hash

  // DNS Propagation
  lastDnsCheck            DateTime?
  dnsCheckAttempts        Int       @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([siteId])
  @@index([hostname])
  @@index([txtVerificationStatus])
  @@index([sslStatus])
  @@index([domainType])
}

enum DomainType {
  WEB2        // Traditional domain (example.com)
  ARNS        // Arweave Name System
  ENS         // Ethereum Name System
  IPNS        // InterPlanetary Name System
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
}

enum SslStatus {
  NONE
  PENDING
  ACTIVE
  EXPIRED
  FAILED
}

model Zone {
  id        String   @id @default(cuid())
  name      String

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
}

// ============================================
// IPFS/STORAGE
// ============================================

model Pin {
  id           String     @id @default(cuid())
  cid          String     @unique
  name         String?
  size         Int?

  deploymentId String     @unique
  deployment   Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([cid])
}

model IPNSRecord {
  id        String   @id @default(cuid())
  name      String   @unique
  hash      String

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([name])
}

// ============================================
// AGENT CHAT SYSTEM
// ============================================

model Agent {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  description String?
  avatar      String?
  systemPrompt String?
  model       String       @default("gpt-4")
  status      AgentStatus  @default(ACTIVE)

  // Agent can be tied to a deployed function or external service
  functionId  String?
  afFunction  AFFunction?  @relation(fields: [functionId], references: [id], onDelete: SetNull)

  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  chats       Chat[]
  messages    Message[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([functionId])
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  TRAINING
  ERROR
}

model Chat {
  id          String      @id @default(cuid())
  title       String?

  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  agentId     String
  agent       Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  messages    Message[]
  attachments Attachment[]

  // Chat metadata
  metadata    Json?

  lastMessageAt DateTime?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
  @@index([agentId])
  @@index([lastMessageAt])
}

model Message {
  id          String        @id @default(cuid())
  content     String
  role        MessageRole

  chatId      String
  chat        Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)

  // Agent that sent the message (if role is AGENT)
  agentId     String?
  agent       Agent?        @relation(fields: [agentId], references: [id], onDelete: SetNull)

  // User that sent the message (if role is USER)
  userId      String?
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  attachments Attachment[]

  // Message metadata (tokens used, model, etc.)
  metadata    Json?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([chatId])
  @@index([agentId])
  @@index([userId])
  @@index([role])
  @@index([createdAt])
}

enum MessageRole {
  USER
  AGENT
  SYSTEM
}

model Attachment {
  id          String   @id @default(cuid())
  filename    String
  contentType String
  size        Int
  url         String

  // Could be stored on IPFS/Arweave
  cid         String?
  storageType StorageType?

  chatId      String?
  chat        Chat?    @relation(fields: [chatId], references: [id], onDelete: Cascade)

  messageId   String?
  message     Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([chatId])
  @@index([messageId])
  @@index([cid])
}

// ============================================
// STORAGE TRACKING
// ============================================

model PinnedContent {
  id          String    @id @default(cuid())

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // IPFS Content Identifier (immutable)
  cid         String

  // Size in bytes (immutable for this CID)
  sizeBytes   BigInt

  // Pin tracking
  pinnedAt    DateTime  @default(now())
  unpinnedAt  DateTime? // Null if still pinned

  // Optional metadata
  filename    String?
  mimeType    String?
  metadata    Json?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([cid])
  @@index([userId, unpinnedAt]) // For quick active pins query
  @@index([pinnedAt])
  @@index([unpinnedAt])
}

model StorageSnapshot {
  id          String   @id @default(cuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Snapshot date (daily)
  date        DateTime

  // Total storage at this date
  totalBytes  BigInt

  // Pin count
  pinCount    Int

  createdAt   DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================
// OBSERVABILITY / APM
// ============================================

model TelemetryIngestion {
  id              String   @id @default(cuid())

  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Ingestion stats per period
  bytesIngested   BigInt   @default(0)
  spansCount      Int      @default(0)
  metricsCount    Int      @default(0)
  logsCount       Int      @default(0)

  // Billing period (hourly granularity)
  periodStart     DateTime
  periodEnd       DateTime

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([projectId, periodStart, periodEnd])
  @@index([projectId])
  @@index([periodStart, periodEnd])
}

model ObservabilitySettings {
  id              String   @id @default(cuid())

  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Feature toggles
  tracesEnabled   Boolean  @default(true)
  metricsEnabled  Boolean  @default(true)
  logsEnabled     Boolean  @default(true)

  // Retention (days)
  traceRetention  Int      @default(7)
  metricRetention Int      @default(30)
  logRetention    Int      @default(7)

  // Sampling rate (1.0 = 100%)
  sampleRate      Float    @default(1.0)

  // Rate limits (null = unlimited)
  maxBytesPerHour BigInt?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
}

// ============================================
// USAGE BUFFERING
// ============================================

model UsageBuffer {
  id        String   @id @default(cuid())
  userId    String   @unique
  
  bandwidth Int      @default(0)
  compute   Int      @default(0)
  requests  Int      @default(0)
  
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model UsageMetadata {
  id        String   @id @default(cuid())
  userId    String
  type      String   // BANDWIDTH, COMPUTE, REQUESTS
  metadata  Json
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// BILLING MODELS
// ============================================

model Customer {
  id               String   @id @default(cuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email            String?
  name             String?
  stripeCustomerId String?  @unique
  
  defaultPaymentMethodId String?
  defaultPaymentMethod   PaymentMethod? @relation("DefaultPaymentMethod", fields: [defaultPaymentMethodId], references: [id])
  
  paymentMethods   PaymentMethod[] @relation("CustomerPaymentMethods")
  subscriptions    Subscription[]
  invoices         Invoice[]
  payments         Payment[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([stripeCustomerId])
}

model PaymentMethod {
  id                    String    @id @default(cuid())
  customerId            String
  customer              Customer  @relation("CustomerPaymentMethods", fields: [customerId], references: [id], onDelete: Cascade)
  
  type                  String    // CARD, CRYPTO
  provider              String    @default("stripe") // stripe, stax, relay
  cardBrand             String?
  cardLast4             String?
  cardExpMonth          Int?
  cardExpYear           Int?
  stripePaymentMethodId String?   @unique
  walletAddress         String?
  blockchain            String?
  isDefault             Boolean   @default(false)
  isActive              Boolean   @default(true)
  
  defaultForCustomers   Customer[] @relation("DefaultPaymentMethod")
  payments              Payment[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([customerId])
}

model SubscriptionPlan {
  id               String   @id @default(cuid())
  name             String   @unique // FREE, STARTER, PRO, ENTERPRISE
  basePricePerSeat Int      // in cents
  usageMarkup      Float    @default(0) // percentage as decimal
  features         String?  // JSON array
  stripePriceId    String?
  
  subscriptions    Subscription[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Subscription {
  id                   String    @id @default(cuid())
  customerId           String
  customer             Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  planId               String
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  
  status               String    // ACTIVE, CANCELED, PAST_DUE, UNPAID, TRIALING
  seats                Int       @default(1)
  stripeSubscriptionId String?   @unique
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAt             DateTime?
  canceledAt           DateTime?
  trialEnd             DateTime?
  
  invoices             Invoice[]
  usageRecords         UsageRecord[]
  
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  
  @@index([customerId])
  @@index([status])
}

model Invoice {
  id               String    @id @default(cuid())
  customerId       String
  customer         Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  subscriptionId   String?
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  invoiceNumber    String    @unique
  status           String    // DRAFT, OPEN, PAID, VOID, UNCOLLECTIBLE
  subtotal         Int       // in cents
  tax              Int       @default(0)
  total            Int
  amountPaid       Int       @default(0)
  amountDue        Int
  currency         String    @default("usd")
  periodStart      DateTime?
  periodEnd        DateTime?
  dueDate          DateTime?
  paidAt           DateTime?
  pdfUrl           String?
  stripeInvoiceId  String?   @unique
  
  lineItems        InvoiceLineItem[]
  payments         Payment[]
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([customerId])
  @@index([status])
}

model InvoiceLineItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Float
  unitPrice   Int      // in cents
  amount      Int      // in cents
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@index([invoiceId])
}

model Payment {
  id                    String    @id @default(cuid())
  customerId            String
  customer              Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  invoiceId             String?
  invoice               Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  
  paymentMethodId       String?
  paymentMethod         PaymentMethod? @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  
  amount                Int       // in cents
  currency              String    @default("usd")
  status                String    // PENDING, SUCCEEDED, FAILED, REFUNDED
  provider              String    @default("stripe") // stripe, stax, relay
  stripePaymentIntentId String?   @unique
  txHash                String?   @unique
  blockchain            String?
  fromAddress           String?
  toAddress             String?
  failureReason         String?
  failureCode           String?
  failureMessage        String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([customerId])
  @@index([invoiceId])
}

model BillingSettings {
  id              String   @id @default(cuid())
  userId          String   @unique
  
  // Feature toggles
  autoPayEnabled  Boolean  @default(true)
  
  // Pricing settings (in cents)
  bandwidthPerGBCents   Int? // cents per GB
  computePerHourCents   Int? // cents per compute hour
  requestsPer1000Cents  Int? // cents per 1000 requests
  storagePerGBCents     Int? // cents per GB per month
  telemetryPerGBCents   Int? // cents per GB telemetry
  pricePerSeatCents     Int? // cents per seat
  usageMarkupPercent    Float? // percentage markup for usage
  
  // Tax settings
  taxId           String?
  taxCountry      String?
  taxRatePercent  Float?   // tax rate percentage
  
  // Invoice settings
  invoiceDueDays  Int?     @default(30)
  
  // Billing address
  billingEmail    String?
  billingAddress  String?
  billingCity     String?
  billingState    String?
  billingZip      String?
  billingCountry  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
}

model UsageRecord {
  id             String   @id @default(cuid())
  customerId     String
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  type           String   // BANDWIDTH, COMPUTE, REQUESTS, STORAGE
  metricType     String   @default("") // storage, bandwidth, compute, requests (alias for type)
  resourceType   String?  // AGGREGATED, etc.
  resourceId     String?  // ID of the resource being tracked
  quantity       Float
  unit           String?  // GB, HOURS, REQUESTS
  unitPrice      Int?     // in cents
  amount         Int?     // in cents
  periodStart    DateTime
  periodEnd      DateTime
  recordedAt     DateTime @default(now())
  timestamp      DateTime @default(now())
  metadata       Json?
  
  createdAt      DateTime @default(now())
  
  @@index([customerId, periodStart])
  @@index([type])
  @@index([metricType])
  @@index([timestamp])
}

// ============================================
// AKASH DEPLOYMENTS
// ============================================

model AkashDeployment {
  id              String              @id @default(cuid())

  // Akash identifiers
  owner           String              // Akash wallet address (owner)
  dseq            BigInt              // Deployment sequence number
  gseq            Int                 @default(1) // Group sequence
  oseq            Int                 @default(1) // Order sequence
  provider        String?             // Provider address once lease created

  // Status tracking
  status          AkashDeploymentStatus @default(CREATING)

  // Service endpoints (populated after manifest sent)
  serviceUrls     Json?               // { serviceName: ["url1", "url2"] }

  // SDL content used for deployment
  sdlContent      String              @db.Text

  // Link to the canonical Service registry (can deploy any service type)
  serviceId       String
  service         Service             @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Optional direct links to specific resource types (for convenience queries)
  afFunctionId    String?
  afFunction      AFFunction?         @relation(fields: [afFunctionId], references: [id], onDelete: SetNull)
  
  siteId          String?
  site            Site?               @relation(fields: [siteId], references: [id], onDelete: SetNull)

  // Cost tracking (on-chain)
  depositUakt     BigInt?             // Deposit amount in uakt
  pricePerBlock   String?             // Price from accepted bid

  // Billing (platform escrow — mirrors on-chain escrow in USD)
  escrow          DeploymentEscrow?   // Platform-level escrow for this deployment
  savedSdl        String?             @db.Text // SDL saved on SUSPEND for re-deploy on resume

  // Error info
  errorMessage    String?

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  deployedAt      DateTime?           // When services became available
  closedAt        DateTime?           // When deployment was closed

  @@unique([owner, dseq])
  @@index([serviceId])
  @@index([afFunctionId])
  @@index([siteId])
  @@index([status])
  @@index([dseq])
}

enum AkashDeploymentStatus {
  CREATING        // Creating deployment on chain
  WAITING_BIDS    // Waiting for provider bids
  SELECTING_BID   // Selecting provider
  CREATING_LEASE  // Creating lease with provider
  SENDING_MANIFEST // Sending manifest to provider
  DEPLOYING       // Provider deploying containers
  ACTIVE          // Deployment running
  FAILED          // Deployment failed
  CLOSED          // Deployment closed (permanent)
  SUSPENDED       // Paused due to low balance (will auto-resume on topup)
}

// ============================================
// DEPLOYMENT ESCROW (Platform-level USD escrow for Akash)
// ============================================

enum EscrowStatus {
  ACTIVE      // Funds locked, daily consumption active
  DEPLETED    // Escrow consumed, needs top-up or auto-top-up from wallet
  REFUNDED    // Deployment closed, remaining refunded to wallet
  PAUSED      // Deployment paused due to low org balance
}

model DeploymentEscrow {
  id                String        @id @default(cuid())
  akashDeploymentId String        @unique @map("akash_deployment_id")
  orgBillingId      String        @map("org_billing_id")    // OrganizationBilling.id from auth service
  organizationId    String        @map("organization_id")

  depositCents      Int           @map("deposit_cents")      // Initial escrow amount (USD cents)
  consumedCents     Int           @default(0) @map("consumed_cents")  // Consumed so far
  dailyRateCents    Int           @map("daily_rate_cents")    // Provider cost/day + margin (USD cents)
  refundedCents     Int           @default(0) @map("refunded_cents")  // Refunded on close
  marginRate        Float         @map("margin_rate")         // Plan markup (0.25 or 0.20)

  status            EscrowStatus  @default(ACTIVE)
  lastBilledAt      DateTime?     @map("last_billed_at")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  akashDeployment   AkashDeployment @relation(fields: [akashDeploymentId], references: [id], onDelete: Cascade)

  @@index([orgBillingId])
  @@index([organizationId])
  @@index([status])
  @@map("deployment_escrow")
}

// ============================================
// PHALA DEPLOYMENTS
// ============================================

enum PhalaDeploymentStatus {
  CREATING   // CVM being created
  STARTING   // CVM starting up
  ACTIVE     // CVM running
  FAILED     // Deployment failed
  STOPPED    // CVM stopped
  DELETED    // CVM deleted
}

model PhalaDeployment {
  id              String                  @id @default(cuid())

  // Identity
  appId           String                  // Phala CVM App ID (hex string from CLI)
  name            String                  // Internal name (e.g. af-<slug>-<suffix>)

  // Status
  status          PhalaDeploymentStatus   @default(CREATING)
  errorMessage    String?

  // Config (what we deployed)
  composeContent  String                  @db.Text
  envKeys         Json?                   // Array of env var keys only (never values)
  cvmSize         String?                 @map("cvm_size") // tdx.small, tdx.medium, tdx.large, tdx.xlarge

  // Outputs
  appUrl          String?
  teepod          String?

  // Billing (per-hour, no escrow — debited directly from wallet)
  hourlyRateCents Int?                    @map("hourly_rate_cents")  // Provider rate + margin (USD cents)
  marginRate      Float?                  @map("margin_rate")        // Plan markup applied
  orgBillingId    String?                 @map("org_billing_id")     // OrganizationBilling.id
  organizationId  String?                 @map("organization_id")
  activeStartedAt DateTime?               @map("active_started_at") // When CVM became ACTIVE
  lastBilledAt    DateTime?               @map("last_billed_at")    // Last time daily job billed this
  totalBilledCents Int                    @default(0) @map("total_billed_cents")

  // Relations
  serviceId       String
  service         Service                 @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  siteId          String?
  site            Site?                   @relation(fields: [siteId], references: [id], onDelete: SetNull)

  afFunctionId    String?
  afFunction      AFFunction?             @relation(fields: [afFunctionId], references: [id], onDelete: SetNull)

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([serviceId])
  @@index([siteId])
  @@index([afFunctionId])
  @@index([status])
  @@index([appId])
  @@index([orgBillingId])
}
