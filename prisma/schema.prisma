// Prisma Schema for AlternateFutures Platform
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  username      String?  @unique
  walletAddress String?  @unique

  projects              Project[]
  personalAccessTokens  PersonalAccessToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
  @@index([walletAddress])
}

model PersonalAccessToken {
  id         String    @id @default(cuid())
  name       String
  token      String    @unique

  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt  DateTime?
  lastUsedAt DateTime?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([userId])
  @@index([token])
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sites     Site[]
  functions AFFunction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([slug])
}

// ============================================
// SITES & DEPLOYMENTS
// ============================================

model Site {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  deployments Deployment[]
  domains     Domain[]
  ipnsRecords IPNSRecord[]
  zones       Zone[]

  primaryDomainId String?
  primaryDomain   Domain? @relation("PrimaryDomain", fields: [primaryDomainId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([slug])
}

model Deployment {
  id          String           @id @default(cuid())
  cid         String
  status      DeploymentStatus @default(PENDING)
  storageType StorageType      @default(IPFS)

  siteId      String
  site        Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)

  pin         Pin?

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([siteId])
  @@index([cid])
  @@index([status])
}

enum DeploymentStatus {
  PENDING
  BUILDING
  UPLOADING
  SUCCESS
  FAILED
}

enum StorageType {
  IPFS
  ARWEAVE
  FILECOIN
}

// ============================================
// FUNCTIONS
// ============================================

model AFFunction {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  invokeUrl           String?
  routes              Json?
  status              FunctionStatus       @default(ACTIVE)

  projectId           String
  project             Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)

  siteId              String?

  currentDeploymentId String?              @unique
  currentDeployment   AFFunctionDeployment? @relation("CurrentDeployment", fields: [currentDeploymentId], references: [id])

  deployments         AFFunctionDeployment[] @relation("FunctionDeployments")

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([projectId])
  @@index([slug])
  @@index([status])
}

model AFFunctionDeployment {
  id              String         @id @default(cuid())
  cid             String
  blake3Hash      String?
  assetsCid       String?
  sgx             Boolean        @default(false)

  afFunctionId String
  afFunction   AFFunction  @relation("FunctionDeployments", fields: [afFunctionId], references: [id], onDelete: Cascade)

  currentFunction AFFunction? @relation("CurrentDeployment")

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([afFunctionId])
  @@index([cid])
}

enum FunctionStatus {
  ACTIVE
  INACTIVE
  DEPLOYING
  FAILED
}

// ============================================
// DOMAINS
// ============================================

model Domain {
  id          String   @id @default(cuid())
  hostname    String   @unique
  verified    Boolean  @default(false)

  siteId      String
  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  primarySite Site[]   @relation("PrimaryDomain")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([siteId])
  @@index([hostname])
}

model Zone {
  id        String   @id @default(cuid())
  name      String

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
}

// ============================================
// IPFS/STORAGE
// ============================================

model Pin {
  id           String     @id @default(cuid())
  cid          String     @unique
  name         String?
  size         Int?

  deploymentId String     @unique
  deployment   Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([cid])
}

model IPNSRecord {
  id        String   @id @default(cuid())
  name      String   @unique
  hash      String

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([name])
}
