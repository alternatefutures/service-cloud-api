// Prisma Schema for AlternateFutures Platform
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  username      String?  @unique
  walletAddress String?  @unique

  projects              Project[]
  personalAccessTokens  PersonalAccessToken[]
  agents                Agent[]
  chats                 Chat[]
  messages              Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
  @@index([walletAddress])
}

model PersonalAccessToken {
  id         String    @id @default(cuid())
  name       String
  token      String    @unique

  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt  DateTime?
  lastUsedAt DateTime?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([userId])
  @@index([token])
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sites     Site[]
  functions AFFunction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([slug])
}

// ============================================
// SITES & DEPLOYMENTS
// ============================================

model Site {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  deployments Deployment[]
  domains     Domain[]
  ipnsRecords IPNSRecord[]
  zones       Zone[]

  primaryDomainId String?
  primaryDomain   Domain? @relation("PrimaryDomain", fields: [primaryDomainId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([slug])
}

model Deployment {
  id          String           @id @default(cuid())
  cid         String
  status      DeploymentStatus @default(PENDING)
  storageType StorageType      @default(IPFS)

  siteId      String
  site        Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)

  pin         Pin?

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([siteId])
  @@index([cid])
  @@index([status])
}

enum DeploymentStatus {
  PENDING
  BUILDING
  UPLOADING
  SUCCESS
  FAILED
}

enum StorageType {
  IPFS
  ARWEAVE
  FILECOIN
}

// ============================================
// FUNCTIONS
// ============================================

model AFFunction {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  invokeUrl           String?
  routes              Json?
  status              FunctionStatus       @default(ACTIVE)

  projectId           String
  project             Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)

  siteId              String?

  currentDeploymentId String?              @unique
  currentDeployment   AFFunctionDeployment? @relation("CurrentDeployment", fields: [currentDeploymentId], references: [id])

  deployments         AFFunctionDeployment[] @relation("FunctionDeployments")
  agents              Agent[]

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([projectId])
  @@index([slug])
  @@index([status])
}

model AFFunctionDeployment {
  id              String         @id @default(cuid())
  cid             String
  blake3Hash      String?
  assetsCid       String?
  sgx             Boolean        @default(false)

  afFunctionId String
  afFunction   AFFunction  @relation("FunctionDeployments", fields: [afFunctionId], references: [id], onDelete: Cascade)

  currentFunction AFFunction? @relation("CurrentDeployment")

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([afFunctionId])
  @@index([cid])
}

enum FunctionStatus {
  ACTIVE
  INACTIVE
  DEPLOYING
  FAILED
}

// ============================================
// DOMAINS
// ============================================

model Domain {
  id          String   @id @default(cuid())
  hostname    String   @unique
  verified    Boolean  @default(false)

  siteId      String
  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  primarySite Site[]   @relation("PrimaryDomain")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([siteId])
  @@index([hostname])
}

model Zone {
  id        String   @id @default(cuid())
  name      String

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
}

// ============================================
// IPFS/STORAGE
// ============================================

model Pin {
  id           String     @id @default(cuid())
  cid          String     @unique
  name         String?
  size         Int?

  deploymentId String     @unique
  deployment   Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([cid])
}

model IPNSRecord {
  id        String   @id @default(cuid())
  name      String   @unique
  hash      String

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([name])
}

// ============================================
// AGENT CHAT SYSTEM
// ============================================

model Agent {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  description String?
  avatar      String?
  systemPrompt String?
  model       String       @default("gpt-4")
  status      AgentStatus  @default(ACTIVE)

  // Agent can be tied to a deployed function or external service
  functionId  String?
  afFunction  AFFunction?  @relation(fields: [functionId], references: [id], onDelete: SetNull)

  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  chats       Chat[]
  messages    Message[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([functionId])
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  TRAINING
  ERROR
}

model Chat {
  id          String      @id @default(cuid())
  title       String?

  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  agentId     String
  agent       Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  messages    Message[]
  attachments Attachment[]

  // Chat metadata
  metadata    Json?

  lastMessageAt DateTime?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
  @@index([agentId])
  @@index([lastMessageAt])
}

model Message {
  id          String        @id @default(cuid())
  content     String
  role        MessageRole

  chatId      String
  chat        Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)

  // Agent that sent the message (if role is AGENT)
  agentId     String?
  agent       Agent?        @relation(fields: [agentId], references: [id], onDelete: SetNull)

  // User that sent the message (if role is USER)
  userId      String?
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  attachments Attachment[]

  // Message metadata (tokens used, model, etc.)
  metadata    Json?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([chatId])
  @@index([agentId])
  @@index([userId])
  @@index([role])
  @@index([createdAt])
}

enum MessageRole {
  USER
  AGENT
  SYSTEM
}

model Attachment {
  id          String   @id @default(cuid())
  filename    String
  contentType String
  size        Int
  url         String

  // Could be stored on IPFS/Arweave
  cid         String?
  storageType StorageType?

  chatId      String?
  chat        Chat?    @relation(fields: [chatId], references: [id], onDelete: Cascade)

  messageId   String?
  message     Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([chatId])
  @@index([messageId])
  @@index([cid])
}
