// Prisma Schema for AlternateFutures Platform
generator client {
  provider      = "prisma-client-js"
  engineType    = "binary"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  username      String?  @unique
  walletAddress String?  @unique

  projects              Project[]
  agents                Agent[]
  chats                 Chat[]
  messages              Message[]
  pinnedContent         PinnedContent[]
  storageSnapshots      StorageSnapshot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
  @@index([walletAddress])
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  organizationId String?  @map("organization_id")

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sites     Site[]
  functions AFFunction[]

  // Observability
  telemetryIngestions   TelemetryIngestion[]
  observabilitySettings ObservabilitySettings?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([slug])
}

// ============================================
// SITES & DEPLOYMENTS
// ============================================

model Site {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  deployments Deployment[]
  domains     Domain[]
  ipnsRecords IPNSRecord[]
  zones       Zone[]

  primaryDomainId String?
  primaryDomain   Domain? @relation("PrimaryDomain", fields: [primaryDomainId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([slug])
}

model Deployment {
  id          String           @id @default(cuid())
  cid         String
  status      DeploymentStatus @default(PENDING)
  storageType StorageType      @default(IPFS)

  siteId      String
  site        Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)

  pin         Pin?

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([siteId])
  @@index([cid])
  @@index([status])
}

enum DeploymentStatus {
  PENDING
  BUILDING
  UPLOADING
  SUCCESS
  FAILED
}

enum StorageType {
  IPFS
  ARWEAVE
  FILECOIN
}

// ============================================
// FUNCTIONS
// ============================================

model AFFunction {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  invokeUrl           String?
  routes              Json?
  status              FunctionStatus       @default(ACTIVE)

  projectId           String
  project             Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)

  siteId              String?

  currentDeploymentId String?              @unique
  currentDeployment   AFFunctionDeployment? @relation("CurrentDeployment", fields: [currentDeploymentId], references: [id])

  deployments         AFFunctionDeployment[] @relation("FunctionDeployments")
  agents              Agent[]

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([projectId])
  @@index([slug])
  @@index([status])
}

model AFFunctionDeployment {
  id              String         @id @default(cuid())
  cid             String
  blake3Hash      String?
  assetsCid       String?
  sgx             Boolean        @default(false)

  afFunctionId String
  afFunction   AFFunction  @relation("FunctionDeployments", fields: [afFunctionId], references: [id], onDelete: Cascade)

  currentFunction AFFunction? @relation("CurrentDeployment")

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([afFunctionId])
  @@index([cid])
}

enum FunctionStatus {
  ACTIVE
  INACTIVE
  DEPLOYING
  FAILED
}

// ============================================
// DOMAINS
// ============================================

model Domain {
  id          String       @id @default(cuid())
  hostname    String       @unique
  verified    Boolean      @default(false)
  domainType  DomainType   @default(WEB2)

  siteId      String
  site        Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)

  primarySite Site[]       @relation("PrimaryDomain")

  // DNS Verification
  txtVerificationToken    String?   // Token to verify via TXT record
  txtVerificationStatus   VerificationStatus @default(PENDING)
  dnsVerifiedAt           DateTime?

  // DNS Records for verification
  expectedCname           String?   // Expected CNAME value
  expectedARecord         String?   // Expected A record value

  // SSL Certificate
  sslStatus               SslStatus @default(NONE)
  sslCertificateId        String?   // Let's Encrypt cert ID
  sslIssuedAt             DateTime?
  sslExpiresAt            DateTime?
  sslAutoRenew            Boolean   @default(true)

  // Web3 Domain Integration
  arnsName                String?   // ArNS name for Arweave
  arnsTransactionId       String?   // Arweave transaction ID
  ensName                 String?   // ENS domain name
  ensContentHash          String?   // ENS content hash
  ipnsHash                String?   // IPNS hash

  // DNS Propagation
  lastDnsCheck            DateTime?
  dnsCheckAttempts        Int       @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([siteId])
  @@index([hostname])
  @@index([txtVerificationStatus])
  @@index([sslStatus])
  @@index([domainType])
}

enum DomainType {
  WEB2        // Traditional domain (example.com)
  ARNS        // Arweave Name System
  ENS         // Ethereum Name System
  IPNS        // InterPlanetary Name System
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
}

enum SslStatus {
  NONE
  PENDING
  ACTIVE
  EXPIRED
  FAILED
}

model Zone {
  id        String   @id @default(cuid())
  name      String

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
}

// ============================================
// IPFS/STORAGE
// ============================================

model Pin {
  id           String     @id @default(cuid())
  cid          String     @unique
  name         String?
  size         Int?

  deploymentId String     @unique
  deployment   Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([cid])
}

model IPNSRecord {
  id        String   @id @default(cuid())
  name      String   @unique
  hash      String

  siteId    String
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([name])
}

// ============================================
// AGENT CHAT SYSTEM
// ============================================

model Agent {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  description String?
  avatar      String?
  systemPrompt String?
  model       String       @default("gpt-4")
  status      AgentStatus  @default(ACTIVE)

  // Agent can be tied to a deployed function or external service
  functionId  String?
  afFunction  AFFunction?  @relation(fields: [functionId], references: [id], onDelete: SetNull)

  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  chats       Chat[]
  messages    Message[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([functionId])
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  TRAINING
  ERROR
}

model Chat {
  id          String      @id @default(cuid())
  title       String?

  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  agentId     String
  agent       Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  messages    Message[]
  attachments Attachment[]

  // Chat metadata
  metadata    Json?

  lastMessageAt DateTime?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
  @@index([agentId])
  @@index([lastMessageAt])
}

model Message {
  id          String        @id @default(cuid())
  content     String
  role        MessageRole

  chatId      String
  chat        Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)

  // Agent that sent the message (if role is AGENT)
  agentId     String?
  agent       Agent?        @relation(fields: [agentId], references: [id], onDelete: SetNull)

  // User that sent the message (if role is USER)
  userId      String?
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  attachments Attachment[]

  // Message metadata (tokens used, model, etc.)
  metadata    Json?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([chatId])
  @@index([agentId])
  @@index([userId])
  @@index([role])
  @@index([createdAt])
}

enum MessageRole {
  USER
  AGENT
  SYSTEM
}

model Attachment {
  id          String   @id @default(cuid())
  filename    String
  contentType String
  size        Int
  url         String

  // Could be stored on IPFS/Arweave
  cid         String?
  storageType StorageType?

  chatId      String?
  chat        Chat?    @relation(fields: [chatId], references: [id], onDelete: Cascade)

  messageId   String?
  message     Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([chatId])
  @@index([messageId])
  @@index([cid])
}

// ============================================
// STORAGE TRACKING
// ============================================

model PinnedContent {
  id          String    @id @default(cuid())

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // IPFS Content Identifier (immutable)
  cid         String

  // Size in bytes (immutable for this CID)
  sizeBytes   BigInt

  // Pin tracking
  pinnedAt    DateTime  @default(now())
  unpinnedAt  DateTime? // Null if still pinned

  // Optional metadata
  filename    String?
  mimeType    String?
  metadata    Json?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([cid])
  @@index([userId, unpinnedAt]) // For quick active pins query
  @@index([pinnedAt])
  @@index([unpinnedAt])
}

model StorageSnapshot {
  id          String   @id @default(cuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Snapshot date (daily)
  date        DateTime

  // Total storage at this date
  totalBytes  BigInt

  // Pin count
  pinCount    Int

  createdAt   DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================
// OBSERVABILITY / APM
// ============================================

model TelemetryIngestion {
  id              String   @id @default(cuid())

  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Ingestion stats per period
  bytesIngested   BigInt   @default(0)
  spansCount      Int      @default(0)
  metricsCount    Int      @default(0)
  logsCount       Int      @default(0)

  // Billing period (hourly granularity)
  periodStart     DateTime
  periodEnd       DateTime

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([projectId, periodStart, periodEnd])
  @@index([projectId])
  @@index([periodStart, periodEnd])
}

model ObservabilitySettings {
  id              String   @id @default(cuid())

  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Feature toggles
  tracesEnabled   Boolean  @default(true)
  metricsEnabled  Boolean  @default(true)
  logsEnabled     Boolean  @default(true)

  // Retention (days)
  traceRetention  Int      @default(7)
  metricRetention Int      @default(30)
  logRetention    Int      @default(7)

  // Sampling rate (1.0 = 100%)
  sampleRate      Float    @default(1.0)

  // Rate limits (null = unlimited)
  maxBytesPerHour BigInt?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
}

// ============================================
// USAGE BUFFERING
// ============================================

model UsageBuffer {
  id        String   @id @default(cuid())
  userId    String   @unique
  
  bandwidth Int      @default(0)
  compute   Int      @default(0)
  requests  Int      @default(0)
  
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model UsageMetadata {
  id        String   @id @default(cuid())
  userId    String
  type      String   // BANDWIDTH, COMPUTE, REQUESTS
  metadata  Json
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}
