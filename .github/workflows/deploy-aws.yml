name: Deploy to AWS (K3s)

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "prisma/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "Dockerfile"
      - "docker-entrypoint.sh"
  workflow_dispatch:

concurrency:
  group: deploy-aws-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE: ghcr.io/${{ github.repository }}

jobs:
  build-and-deploy:
    name: Build, Push & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout into service-cloud-api subdirectory
        uses: actions/checkout@v4
        with:
          path: service-cloud-api

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: service-cloud-api/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.IMAGE }}:latest
            ${{ env.IMAGE }}:${{ github.sha }}

      - name: Set up kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy to K3s
        run: |
          kubectl set image deployment/service-cloud-api \
            service-cloud-api=${{ env.IMAGE }}:${{ github.sha }} \
            -n af-production
          kubectl rollout status deployment/service-cloud-api \
            -n af-production --timeout=180s

      - name: Run Prisma migrations
        run: |
          kubectl exec deployment/service-cloud-api -n af-production -- prisma migrate deploy

      - name: Verify deployment
        run: |
          kubectl get pods -n af-production -l app=service-cloud-api
          echo "---"
          sleep 10
          curl -sf --max-time 10 https://api.alternatefutures.ai/health && echo "API healthy" || echo "::warning::Health check did not pass yet"
