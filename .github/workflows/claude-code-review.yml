name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, staging, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR diff
          DIFF=$(git diff origin/main...HEAD)

          if [ -z "$DIFF" ]; then
            echo "No changes to review"
            exit 0
          fi

          # Limit diff size (first 30000 chars to stay within API limits)
          DIFF_TRUNCATED=$(echo "$DIFF" | head -c 30000)
          if [ ${#DIFF} -gt 30000 ]; then
            DIFF_TRUNCATED="$DIFF_TRUNCATED\n\n... (diff truncated)"
          fi

          # Create API request payload using jq
          PAYLOAD=$(jq -n \
            --arg diff "$DIFF_TRUNCATED" \
            '{
              model: "claude-sonnet-4-5-20250929",
              max_tokens: 4096,
              messages: [{
                role: "user",
                content: ("Review this code change and provide concise feedback on: 1. Potential bugs or issues, 2. Security concerns, 3. Performance improvements, 4. Best practices violations. Be concise and only mention significant issues.\n\nDiff:\n```diff\n" + $diff + "\n```")
              }]
            }')

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$PAYLOAD")

          # Extract review text
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "Review generation failed"')

          # Post as PR comment
          COMMENT_BODY=$(jq -n --arg review "$REVIEW" '{
            body: ("## ðŸ¤– Claude Code Review\n\n" + $review + "\n\n---\n*Powered by Claude Sonnet 4.5*")
          }')

          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$COMMENT_BODY" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"

          echo "âœ… Claude Code Review completed"
