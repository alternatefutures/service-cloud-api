name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, staging, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Shallow clone - only need current and previous commit

      - name: Claude Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail  # Enable strict error handling

          # Get PR diff
          DIFF=$(git diff origin/main...HEAD) || {
            echo "Error: Failed to generate diff"
            exit 1
          }

          if [ -z "$DIFF" ]; then
            echo "No changes to review"
            exit 0
          fi

          # Limit diff size using proper character counting
          DIFF_SIZE=$(echo -n "$DIFF" | wc -c | tr -d ' ')
          MAX_SIZE=30000

          if [ "$DIFF_SIZE" -gt "$MAX_SIZE" ]; then
            DIFF_TRUNCATED=$(echo "$DIFF" | head -c "$MAX_SIZE")
            echo "Warning: Diff truncated from $DIFF_SIZE to $MAX_SIZE characters"
          else
            DIFF_TRUNCATED="$DIFF"
          fi

          # Create API request payload using jq (prevents injection)
          PAYLOAD=$(jq -n \
            --arg diff "$DIFF_TRUNCATED" \
            '{
              model: "claude-sonnet-4-5-20250929",
              max_tokens: 4096,
              messages: [{
                role: "user",
                content: ("Review this code change and provide concise feedback on: 1. Potential bugs or issues, 2. Security concerns, 3. Performance improvements, 4. Best practices violations. Be concise and only mention significant issues.\n\nDiff:\n```diff\n" + $diff + "\n```")
              }]
            }') || {
            echo "Error: Failed to create API payload"
            exit 1
          }

          # Call Claude API with error handling
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/response.json \
            https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$PAYLOAD")

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: Claude API returned HTTP $HTTP_CODE"
            cat /tmp/response.json
            exit 1
          fi

          # Extract review text
          REVIEW=$(jq -r '.content[0].text // "Review generation failed"' /tmp/response.json) || {
            echo "Error: Failed to parse API response"
            exit 1
          }

          if [ "$REVIEW" = "Review generation failed" ]; then
            echo "Error: Claude API did not return valid content"
            cat /tmp/response.json
            exit 1
          fi

          # Post as PR comment (using Authorization header for security)
          COMMENT_BODY=$(jq -n --arg review "$REVIEW" '{
            body: ("## ðŸ¤– Claude Code Review\n\n" + $review + "\n\n---\n*Powered by Claude Sonnet 4.5*")
          }')

          COMMENT_HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/comment_response.json \
            -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "$COMMENT_BODY" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")

          if [ "$COMMENT_HTTP_CODE" -ne 201 ]; then
            echo "Error: Failed to post comment (HTTP $COMMENT_HTTP_CODE)"
            cat /tmp/comment_response.json
            exit 1
          fi

          # Clean up temp files
          rm -f /tmp/response.json /tmp/comment_response.json

          echo "âœ… Claude Code Review completed successfully"
