# Deploy Infisical secrets manager to Akash Network
name: Deploy Infisical to Akash
permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - update
          - close

concurrency:
  group: akash-infisical-deployment
  cancel-in-progress: false

jobs:
  deploy-infisical:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SOPS
        run: |
          cd /tmp
          wget https://github.com/getsops/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64
          chmod +x sops-v3.9.0.linux.amd64
          sudo mv sops-v3.9.0.linux.amd64 /usr/local/bin/sops
          sops --version

      - name: Decrypt bootstrap secrets
        env:
          SOPS_AGE_KEY: ${{ secrets.AGE_SECRET_KEY }}
        run: |
          sops -d bootstrap.enc.env > bootstrap.env
          echo "Decrypted bootstrap secrets"

      - name: Load bootstrap secrets
        run: |
          set -a
          source bootstrap.env
          set +a
          echo "INFISICAL_ENCRYPTION_KEY=$INFISICAL_ENCRYPTION_KEY" >> $GITHUB_ENV
          echo "INFISICAL_JWT_SECRET=$INFISICAL_JWT_SECRET" >> $GITHUB_ENV
          echo "MONGO_INITDB_ROOT_PASSWORD=$MONGO_INITDB_ROOT_PASSWORD" >> $GITHUB_ENV

      - name: Install Akash CLI
        run: |
          cd /tmp
          curl -sfL "https://github.com/akash-network/node/releases/download/v1.0.2/akash_1.0.2_linux_amd64.zip" -o akash.zip
          unzip akash.zip
          sudo mv akash /usr/local/bin/
          chmod +x /usr/local/bin/akash
          akash version

      - name: Install provider-services CLI
        run: |
          cd /tmp
          curl -sfL https://raw.githubusercontent.com/akash-network/provider/main/install.sh | bash
          sudo mv ./bin/provider-services /usr/local/bin/
          chmod +x /usr/local/bin/provider-services
          provider-services version

      - name: Setup Akash wallet
        env:
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
          AKASH_MNEMONIC: ${{ secrets.AKASH_MNEMONIC }}
        run: |
          echo "$AKASH_MNEMONIC" | akash keys add $AKASH_KEY_NAME --recover --keyring-backend test
          AKASH_ADDRESS=$(akash keys show $AKASH_KEY_NAME -a --keyring-backend test)
          echo "AKASH_ADDRESS=$AKASH_ADDRESS" >> $GITHUB_ENV
          echo "Wallet address: $AKASH_ADDRESS"

      - name: Check wallet balance
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
        run: |
          akash query bank balances ${{ env.AKASH_ADDRESS }} --node $AKASH_NODE

      - name: Substitute secrets in SDL
        run: |
          cp deploy-infisical.yaml deploy-infisical-final.yaml

          # Substitute bootstrap secrets
          sed -i "s|PLACEHOLDER_ENCRYPTION_KEY|${{ env.INFISICAL_ENCRYPTION_KEY }}|g" deploy-infisical-final.yaml
          sed -i "s|PLACEHOLDER_JWT_SECRET|${{ env.INFISICAL_JWT_SECRET }}|g" deploy-infisical-final.yaml
          sed -i "s|PLACEHOLDER_MONGO_PASSWORD|${{ env.MONGO_INITDB_ROOT_PASSWORD }}|g" deploy-infisical-final.yaml

          echo "SDL prepared with secrets"

      - name: Setup certificates
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
          AKASH_CLIENT_CRT: ${{ secrets.AKASH_CLIENT_CRT }}
          AKASH_CLIENT_KEY: ${{ secrets.AKASH_CLIENT_KEY }}
        run: |
          CERT_PATH="$HOME/.akash/certs"
          mkdir -p "$CERT_PATH"

          # Check if certificates are stored in secrets
          if [ -n "$AKASH_CLIENT_CRT" ] && [ -n "$AKASH_CLIENT_KEY" ]; then
            echo "Restoring certificates from GitHub Secrets..."
            echo "$AKASH_CLIENT_CRT" | base64 -d > "$CERT_PATH/client.crt"
            echo "$AKASH_CLIENT_KEY" | base64 -d > "$CERT_PATH/client.key"
            chmod 600 "$CERT_PATH/client.crt" "$CERT_PATH/client.key"
            echo "Certificates restored"
          else
            echo "Generating new certificates..."
            akash tx cert generate client --from $AKASH_KEY_NAME --keyring-backend test
            akash tx cert publish client \
              --from $AKASH_KEY_NAME \
              --keyring-backend test \
              --node $AKASH_NODE \
              --chain-id $AKASH_CHAIN_ID \
              --gas-prices 0.025uakt \
              --gas auto \
              --gas-adjustment 1.5 \
              -y
            sleep 15

            # Copy generated certificates to expected location
            if [ -f "$HOME/.akash/client.crt" ] && [ -f "$HOME/.akash/client.key" ]; then
              cp "$HOME/.akash/client.crt" "$CERT_PATH/client.crt"
              cp "$HOME/.akash/client.key" "$CERT_PATH/client.key"
              chmod 600 "$CERT_PATH/client.crt" "$CERT_PATH/client.key"
              echo "Certificates copied to $CERT_PATH"
            else
              echo "Warning: Generated certificates not found in expected location"
            fi
          fi

          # Verify certificates exist
          if [ -f "$CERT_PATH/client.crt" ] && [ -f "$CERT_PATH/client.key" ]; then
            echo "âœ“ Client certificates ready at $CERT_PATH"
            ls -lh "$CERT_PATH"

            # Remove any old PEM files to avoid conflicts with separate cert/key files
            # PEM files may have encrypted keys that require passphrases
            if [ -f "$HOME/.akash"/*.pem ]; then
              echo "Removing old PEM files to avoid conflicts..."
              rm -f "$HOME/.akash"/*.pem
            fi
          else
            echo "âœ— Client certificates not found at $CERT_PATH"
            ls -lha "$HOME/.akash" || true
          fi

      - name: Create deployment
        if: ${{ github.event.inputs.action == 'deploy' }}
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
        run: |
          TX_OUTPUT=$(akash tx deployment create deploy-infisical-final.yaml \
            --from $AKASH_KEY_NAME \
            --keyring-backend test \
            --node $AKASH_NODE \
            --chain-id $AKASH_CHAIN_ID \
            --gas auto \
            --gas-adjustment 1.5 \
            --gas-prices 0.025uakt \
            -y \
            --output json)

          echo "$TX_OUTPUT"
          TX_HASH=$(echo "$TX_OUTPUT" | jq -r '.txhash')
          echo "DEPLOYMENT_TX=$TX_HASH" >> $GITHUB_ENV
          echo "Deployment transaction: $TX_HASH"

          sleep 15

      - name: Get deployment DSEQ
        if: ${{ github.event.inputs.action == 'deploy' }}
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
        run: |
          TX_RESULT=$(akash query tx ${{ env.DEPLOYMENT_TX }} --node $AKASH_NODE --chain-id $AKASH_CHAIN_ID --output json)

          DSEQ=$(echo "$TX_RESULT" | jq -r '
            .events[]?
            | select(.type=="akash.deployment.v1.EventDeploymentCreated")
            | .attributes[]?
            | select(.key=="id")
            | .value
            | fromjson
            | .dseq
          ' 2>/dev/null || echo "")

          if [ -z "$DSEQ" ] || [ "$DSEQ" == "null" ]; then
            sleep 10
            DSEQ=$(akash query deployment list --owner ${{ env.AKASH_ADDRESS }} --node $AKASH_NODE --output json | jq -r '.deployments[]?.deployment?.deployment_id?.dseq' 2>/dev/null | head -n1)
          fi

          echo "DSEQ=$DSEQ" >> $GITHUB_ENV
          echo "Deployment DSEQ: $DSEQ"

      - name: Wait for bids
        if: ${{ github.event.inputs.action == 'deploy' }}
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
        run: |
          echo "Waiting for provider bids..."
          ATTEMPTS=12
          for i in $(seq 1 $ATTEMPTS); do
            BID_COUNT=$(akash query market bid list --owner ${{ env.AKASH_ADDRESS }} --dseq ${{ env.DSEQ }} --node $AKASH_NODE --output json | jq '.bids | length')
            echo "Attempt $i/$ATTEMPTS: $BID_COUNT bids received"

            if [ "$BID_COUNT" -gt "0" ]; then
              echo "Bids received!"
              break
            fi

            sleep 10
          done

      - name: Accept best bid (with uptime filter)
        if: ${{ github.event.inputs.action == 'deploy' }}
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
          MIN_UPTIME: 99.9
        run: |
          BIDS=$(akash query market bid list --owner ${{ env.AKASH_ADDRESS }} --dseq ${{ env.DSEQ }} --node $AKASH_NODE --output json)

          # Blocklist of providers with known issues
          BLOCKLIST=(
            "akash1r2yz5fzkk9gt0r3mk9u2c29q5mmtef050cryak"  # Never responds with service info
          )

          echo "=== Filtering bids by provider uptime (minimum: ${MIN_UPTIME}%) ==="

          # Get list of all providers from bids
          PROVIDERS=$(echo "$BIDS" | jq -r '.bids[].bid.id.provider')

          # Create a filtered bids array
          FILTERED_BIDS="[]"

          for PROVIDER_ADDR in $PROVIDERS; do
            # Check blocklist first
            BLOCKED=false
            for BLOCKED_PROVIDER in "${BLOCKLIST[@]}"; do
              if [ "$PROVIDER_ADDR" == "$BLOCKED_PROVIDER" ]; then
                echo "Checking provider: $PROVIDER_ADDR"
                echo "  âœ— BLOCKED - Provider has known reliability issues"
                BLOCKED=true
                break
              fi
            done

            if [ "$BLOCKED" == "true" ]; then
              continue
            fi

            echo "Checking provider: $PROVIDER_ADDR"

            # Query provider attributes from Akash
            PROVIDER_INFO=$(akash query provider get "$PROVIDER_ADDR" --node $AKASH_NODE --output json 2>/dev/null || echo '{}')

            # Try to get uptime from provider attributes
            # Note: Akash providers may not expose uptime directly, so we'll use akashlytics.com API
            UPTIME=$(curl -s "https://api.akashlytics.com/v1/providers/$PROVIDER_ADDR" 2>/dev/null | jq -r '.uptime // null' || echo "null")

            if [ "$UPTIME" == "null" ] || [ -z "$UPTIME" ]; then
              echo "  âš ï¸  Uptime data not available for $PROVIDER_ADDR, including anyway"
              # If uptime data not available, include the provider (fail open)
              BID=$(echo "$BIDS" | jq ".bids[] | select(.bid.id.provider == \"$PROVIDER_ADDR\")")
              FILTERED_BIDS=$(echo "$FILTERED_BIDS" | jq ". + [$BID]")
            else
              # Convert uptime to comparable format (handle percentage)
              UPTIME_VALUE=$(echo "$UPTIME" | sed 's/%//')

              # Compare uptime (using bc for float comparison)
              if (( $(echo "$UPTIME_VALUE >= $MIN_UPTIME" | bc -l) )); then
                echo "  âœ“ Uptime: ${UPTIME_VALUE}% (passes ${MIN_UPTIME}% threshold)"
                BID=$(echo "$BIDS" | jq ".bids[] | select(.bid.id.provider == \"$PROVIDER_ADDR\")")
                FILTERED_BIDS=$(echo "$FILTERED_BIDS" | jq ". + [$BID]")
              else
                echo "  âœ— Uptime: ${UPTIME_VALUE}% (below ${MIN_UPTIME}% threshold) - SKIPPED"
              fi
            fi
          done

          echo ""
          echo "=== Filtered bids (uptime â‰¥ ${MIN_UPTIME}%) ==="
          BID_COUNT=$(echo "$FILTERED_BIDS" | jq 'length')
          echo "Qualified providers: $BID_COUNT"

          if [ "$BID_COUNT" -eq "0" ]; then
            echo "Error: No providers meet the uptime requirement of ${MIN_UPTIME}%"
            echo "Consider lowering MIN_UPTIME or waiting for more bids"
            exit 1
          fi

          echo "$FILTERED_BIDS" | jq -r '.[] | "\(.bid.id.provider) - \(.bid.price.amount) uakt"'

          # Select lowest price bid from filtered results
          LOWEST_BID=$(echo "$FILTERED_BIDS" | jq 'sort_by(.bid.price.amount | tonumber) | .[0]')
          PROVIDER=$(echo "$LOWEST_BID" | jq -r '.bid.id.provider')
          PRICE=$(echo "$LOWEST_BID" | jq -r '.bid.price.amount')

          echo ""
          echo "Accepting bid from provider: $PROVIDER (Price: $PRICE uakt)"

          akash tx market lease create \
            --dseq ${{ env.DSEQ }} \
            --provider $PROVIDER \
            --from $AKASH_KEY_NAME \
            --keyring-backend test \
            --node $AKASH_NODE \
            --chain-id $AKASH_CHAIN_ID \
            --gas auto \
            --gas-adjustment 1.5 \
            --gas-prices 0.025uakt \
            -y

          echo "PROVIDER=$PROVIDER" >> $GITHUB_ENV

      - name: Wait for deployment to be ready
        if: ${{ github.event.inputs.action == 'deploy' }}
        env:
          AKASH_KEY_NAME: deploy
        run: |
          echo "Waiting for deployment to be accessible on provider..."
          echo "Polling lease-status until provider responds..."

          TIMEOUT=300  # 5 minutes max
          ELAPSED=0
          INTERVAL=10  # Check every 10 seconds

          while [ $ELAPSED -lt $TIMEOUT ]; do
            echo "Checking lease status... (${ELAPSED}s elapsed)"

            # Try to get lease status
            if provider-services lease-status \
              --dseq ${{ env.DSEQ }} \
              --provider ${{ env.PROVIDER }} \
              --from $AKASH_KEY_NAME 2>&1 | grep -q "services"; then
              echo "âœ“ Deployment is ready! Provider is responding with service info."
              exit 0
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          # Timeout reached
          echo "âš  Timeout after ${TIMEOUT}s - deployment may still be starting"
          echo "DNS sync will retry if provider isn't ready yet"
          exit 0

      - name: Setup Node.js for DNS sync
        if: ${{ github.event.inputs.action == 'deploy' }}
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies for DNS sync
        if: ${{ github.event.inputs.action == 'deploy' }}
        run: |
          npm install -g tsx
          npm install

      - name: Sync DNS for Infisical
        if: ${{ github.event.inputs.action == 'deploy' }}
        continue-on-error: true
        env:
          OPENPROVIDER_USERNAME: ${{ secrets.OPENPROVIDER_USERNAME }}
          OPENPROVIDER_PASSWORD: ${{ secrets.OPENPROVIDER_PASSWORD }}
          DOMAIN: alternatefutures.ai
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
          AKASH_ADDRESS: ${{ env.AKASH_ADDRESS }}
          AKASH_KEY_NAME: deploy
          AKASH_KEYRING_BACKEND: test
        run: |
          echo "Configuring DNS: secrets.alternatefutures.ai"
          if [ -z "${{ env.PROVIDER }}" ] || [ "${{ env.PROVIDER }}" == "null" ]; then
            echo "Warning: Provider address not available, skipping DNS sync"
            echo "You can manually configure DNS using the deployment info from the logs above"
            exit 0
          fi

          if [ -z "$OPENPROVIDER_USERNAME" ] || [ -z "$OPENPROVIDER_PASSWORD" ]; then
            echo "Warning: OpenProvider credentials not available, skipping DNS sync"
            echo ""
            echo "To enable automatic DNS configuration:"
            echo "1. Add OPENPROVIDER_USERNAME and OPENPROVIDER_PASSWORD to GitHub Secrets"
            echo "2. Re-run this workflow"
            echo ""
            echo "Manual DNS Configuration:"
            echo "  You can configure DNS manually using the deployment info above"
            echo "  Point secrets.alternatefutures.ai to the Infisical service URI"
            exit 0
          fi

          echo "Using existing AkashDNSSync service..."
          tsx scripts/sync-dns.ts ${{ env.DSEQ }} ${{ env.PROVIDER }}

      - name: Deployment summary
        if: always()
        run: |
          # Console output for CLI/workflow logs
          echo ""
          echo "=========================================="
          echo "ðŸš€ INFISICAL DEPLOYMENT SUCCESSFUL"
          echo "=========================================="
          echo ""
          echo "Deployment Details:"
          echo "  Action:      ${{ github.event.inputs.action }}"
          echo "  Wallet:      ${{ env.AKASH_ADDRESS }}"

          if [ -n "${{ env.DSEQ }}" ]; then
            echo "  DSEQ:        ${{ env.DSEQ }}"
            echo "  Provider:    ${{ env.PROVIDER }}"
            echo "  Transaction: ${{ env.DEPLOYMENT_TX }}"
          fi

          echo ""
          echo "ðŸŒ Service Endpoint:"
          echo "  https://secrets.alternatefutures.ai"
          echo ""
          echo "ðŸ“ Next Steps:"
          echo "  1. Wait for DNS propagation (2-5 minutes)"
          echo "  2. Access Infisical at https://secrets.alternatefutures.ai"
          echo "  3. Create initial admin user"
          echo "  4. Create project and add secrets"
          echo "  5. Generate service token for main app deployment"
          echo "  6. Add INFISICAL_SERVICE_TOKEN and INFISICAL_PROJECT_ID to GitHub Secrets"
          echo ""
          echo "=========================================="
          echo ""

          # GitHub Actions summary for UI
          echo "## Infisical Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Wallet**: ${{ env.AKASH_ADDRESS }}" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ env.DSEQ }}" ]; then
            echo "- **DSEQ**: ${{ env.DSEQ }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Provider**: ${{ env.PROVIDER }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Transaction**: ${{ env.DEPLOYMENT_TX }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Endpoint" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ https://secrets.alternatefutures.ai** (Infisical UI)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait for DNS propagation (2-5 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "2. Access Infisical at https://secrets.alternatefutures.ai" >> $GITHUB_STEP_SUMMARY
          echo "3. Create initial admin user" >> $GITHUB_STEP_SUMMARY
          echo "4. Create project and add secrets" >> $GITHUB_STEP_SUMMARY
          echo "5. Generate service token for main app deployment" >> $GITHUB_STEP_SUMMARY
          echo "6. Add INFISICAL_SERVICE_TOKEN and INFISICAL_PROJECT_ID to GitHub Secrets" >> $GITHUB_STEP_SUMMARY
