name: Update DNS via Infisical

on:
  workflow_dispatch:
    inputs:
      static_ip:
        description: 'Static IP address for DNS A records'
        required: true
        default: '62.3.50.131'
      subdomains:
        description: 'Comma-separated list of subdomains to update'
        required: true
        default: 'api,auth,secrets'

jobs:
  update-dns:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Infisical CLI
        run: |
          # Use the official install script
          curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash || true
          sudo apt-get install -y infisical || {
            # Fallback: download binary directly
            echo "Falling back to direct binary download..."
            INFISICAL_VERSION=$(curl -s https://api.github.com/repos/Infisical/infisical/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
            curl -L "https://github.com/Infisical/infisical/releases/download/infisical-cli/v${INFISICAL_VERSION}/infisical_${INFISICAL_VERSION}_linux_amd64.tar.gz" -o /tmp/infisical.tar.gz
            sudo tar -xzf /tmp/infisical.tar.gz -C /usr/local/bin infisical
            sudo chmod +x /usr/local/bin/infisical
          }
          infisical --version

      - name: Fetch OpenProvider Credentials from Infisical
        env:
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
        run: |
          # Login to Infisical using Universal Auth
          infisical login --method=universal-auth \
            --client-id=$INFISICAL_CLIENT_ID \
            --client-secret=$INFISICAL_CLIENT_SECRET \
            --domain=https://secrets.alternatefutures.ai

          # Export secrets to environment
          echo "Fetching OpenProvider credentials..."
          OPENPROVIDER_USERNAME=$(infisical secrets get OPENPROVIDER_USERNAME --env=prod --projectId=$INFISICAL_PROJECT_ID --domain=https://secrets.alternatefutures.ai --plain 2>/dev/null || echo "")
          OPENPROVIDER_PASSWORD=$(infisical secrets get OPENPROVIDER_PASSWORD --env=prod --projectId=$INFISICAL_PROJECT_ID --domain=https://secrets.alternatefutures.ai --plain 2>/dev/null || echo "")

          if [ -z "$OPENPROVIDER_USERNAME" ] || [ -z "$OPENPROVIDER_PASSWORD" ]; then
            echo "Warning: Could not fetch OpenProvider credentials from Infisical"
            echo "Falling back to GitHub secrets..."
            echo "OPENPROVIDER_USERNAME=${{ secrets.OPENPROVIDER_USERNAME }}" >> $GITHUB_ENV
            echo "OPENPROVIDER_PASSWORD=${{ secrets.OPENPROVIDER_PASSWORD }}" >> $GITHUB_ENV
          else
            echo "Successfully fetched OpenProvider credentials from Infisical"
            echo "OPENPROVIDER_USERNAME=$OPENPROVIDER_USERNAME" >> $GITHUB_ENV
            echo "OPENPROVIDER_PASSWORD=$OPENPROVIDER_PASSWORD" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: npm ci

      - name: Update DNS Records
        env:
          STATIC_IP: ${{ inputs.static_ip }}
          SUBDOMAINS: ${{ inputs.subdomains }}
        run: |
          npx tsx scripts/update-dns-static-ip.ts

      - name: Verify DNS Propagation
        run: |
          echo "Checking DNS resolution for updated records..."
          for subdomain in $(echo "${{ inputs.subdomains }}" | tr ',' ' '); do
            echo "Checking ${subdomain}.alternatefutures.ai..."
            dig +short ${subdomain}.alternatefutures.ai A || echo "Resolution pending..."
          done

      - name: Summary
        run: |
          echo "## DNS Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target IP**: \`${{ inputs.static_ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Subdomains Updated**:" >> $GITHUB_STEP_SUMMARY
          for subdomain in $(echo "${{ inputs.subdomains }}" | tr ',' ' '); do
            echo "- ${subdomain}.alternatefutures.ai" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: DNS propagation may take 5-30 minutes to complete globally._" >> $GITHUB_STEP_SUMMARY
