name: Cleanup Akash Deployments (v3)
permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Cleanup mode'
        required: true
        default: 'keep-latest'
        type: choice
        options:
          - keep-latest
          - close-all

jobs:
  cleanup:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Akash CLI
        run: |
          cd /tmp
          curl -sfL "https://github.com/akash-network/node/releases/download/v1.0.2/akash_1.0.2_linux_amd64.zip" -o akash.zip
          unzip akash.zip
          sudo mv akash /usr/local/bin/
          chmod +x /usr/local/bin/akash
          akash version

      - name: Setup Akash wallet
        env:
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
          AKASH_MNEMONIC: ${{ secrets.AKASH_MNEMONIC }}
        run: |
          echo "$AKASH_MNEMONIC" | akash keys add $AKASH_KEY_NAME --recover --keyring-backend test
          AKASH_ADDRESS=$(akash keys show $AKASH_KEY_NAME -a --keyring-backend test)
          echo "AKASH_ADDRESS=$AKASH_ADDRESS" >> $GITHUB_ENV
          echo "Wallet address: $AKASH_ADDRESS"

      - name: List active deployments
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
        run: |
          echo "=== Active Deployments ==="
          akash query deployment list --owner ${{ env.AKASH_ADDRESS }} --node $AKASH_NODE --output json | jq -r '.deployments[] | "\(.deployment.deployment_id.dseq) - Created at block \(.deployment.created_at)"'

      - name: Clean up deployments
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
          MODE: ${{ inputs.mode }}
        run: |
          # Get all deployments
          DEPLOYMENTS=$(akash query deployment list --owner ${{ env.AKASH_ADDRESS }} --node $AKASH_NODE --output json)
          DEPLOYMENT_COUNT=$(echo "$DEPLOYMENTS" | jq '.deployments | length')

          echo "Found $DEPLOYMENT_COUNT active deployments"

          if [ "$DEPLOYMENT_COUNT" -eq 0 ]; then
            echo "No deployments to clean up"
            exit 0
          fi

          # Debug: Show deployment structure
          echo "First deployment structure:"
          echo "$DEPLOYMENTS" | jq '.deployments[0]'

          # Determine which deployments to close
          if [ "$MODE" == "keep-latest" ]; then
            # Filter out null DSEQs and sort by DSEQ number
            LATEST_DSEQ=$(echo "$DEPLOYMENTS" | jq -r '.deployments | map(select(.deployment.deployment_id.dseq != null)) | sort_by(.deployment.deployment_id.dseq | tonumber) | .[-1].deployment.deployment_id.dseq')
            echo "Keeping latest deployment: $LATEST_DSEQ"
            DSEQS_TO_CLOSE=$(echo "$DEPLOYMENTS" | jq -r ".deployments[] | select(.deployment.deployment_id.dseq != null and .deployment.deployment_id.dseq != \"$LATEST_DSEQ\") | .deployment.deployment_id.dseq")
          else
            echo "Closing ALL deployments"
            DSEQS_TO_CLOSE=$(echo "$DEPLOYMENTS" | jq -r '.deployments[] | select(.deployment.deployment_id.dseq != null) | .deployment.deployment_id.dseq')
          fi

          # Close deployments
          CLOSED_COUNT=0
          for DSEQ in $DSEQS_TO_CLOSE; do
            echo "Closing deployment $DSEQ..."

            akash tx deployment close \
              --dseq $DSEQ \
              --from $AKASH_KEY_NAME \
              --keyring-backend $AKASH_KEYRING_BACKEND \
              --node $AKASH_NODE \
              --chain-id $AKASH_CHAIN_ID \
              --gas-prices 0.025uakt \
              --gas auto \
              --gas-adjustment 1.5 \
              -y

            CLOSED_COUNT=$((CLOSED_COUNT + 1))
            echo "âœ“ Deployment $DSEQ closed"

            sleep 2
          done

          echo "CLOSED_COUNT=$CLOSED_COUNT" >> $GITHUB_ENV

      - name: Summary
        if: always()
        run: |
          echo "## Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Closed**: ${{ env.CLOSED_COUNT }} deployment(s)" >> $GITHUB_STEP_SUMMARY
          echo "- **Wallet**: ${{ env.AKASH_ADDRESS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate returned deposits
          DEPOSIT_PER_DEPLOYMENT=500000
          TOTAL_RETURNED=$((CLOSED_COUNT * DEPOSIT_PER_DEPLOYMENT))
          TOTAL_RETURNED_AKT=$(echo "scale=2; $TOTAL_RETURNED / 1000000" | bc)

          echo "ðŸ’° **Deposits Returned**: ~${TOTAL_RETURNED_AKT} AKT" >> $GITHUB_STEP_SUMMARY
