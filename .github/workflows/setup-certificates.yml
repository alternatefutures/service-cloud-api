name: Setup Akash Certificates

on:
  workflow_dispatch:

jobs:
  setup-certs:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Install Akash CLI
        run: |
          cd /tmp
          curl -sfL "https://github.com/akash-network/node/releases/download/v1.0.2/akash_1.0.2_linux_amd64.zip" -o akash.zip
          unzip akash.zip
          sudo mv akash /usr/local/bin/
          chmod +x /usr/local/bin/akash
          akash version

      - name: Setup Akash wallet
        env:
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
          AKASH_MNEMONIC: ${{ secrets.AKASH_MNEMONIC }}
        run: |
          echo "$AKASH_MNEMONIC" | akash keys add $AKASH_KEY_NAME --recover --keyring-backend test
          AKASH_ADDRESS=$(akash keys show $AKASH_KEY_NAME -a --keyring-backend test)
          echo "AKASH_ADDRESS=$AKASH_ADDRESS" >> $GITHUB_ENV
          echo "Wallet address: $AKASH_ADDRESS"

      - name: Generate and publish certificate
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
        run: |
          # Create certificate directory
          CERT_PATH="$HOME/.akash/certs"
          mkdir -p "$CERT_PATH"

          echo "Generating certificate..."
          akash tx cert generate client --from $AKASH_KEY_NAME --keyring-backend test

          # Debug: Check entire .akash directory structure
          echo "Contents of ~/.akash:"
          ls -laR "$HOME/.akash" || echo "Directory not found"

          # Verify certificate files were created
          echo "Checking certificate files in $CERT_PATH..."
          if [ -d "$CERT_PATH" ]; then
            ls -la "$CERT_PATH"
          else
            echo "ERROR: Certificate directory $CERT_PATH does not exist"
            echo "Searching for certificate files..."
            find "$HOME/.akash" -name "*.crt" -o -name "*.key" 2>/dev/null || echo "No certificate files found"
          fi

          # Check if files exist, if not try to find them
          if [ ! -f "$CERT_PATH/client.crt" ]; then
            echo "WARNING: client.crt not found in expected location"
            echo "Searching entire .akash directory..."
            find "$HOME/.akash" -type f 2>/dev/null
          fi

          echo "Publishing certificate to blockchain..."
          akash tx cert publish client \
            --from $AKASH_KEY_NAME \
            --keyring-backend test \
            --node $AKASH_NODE \
            --chain-id $AKASH_CHAIN_ID \
            --gas-prices 0.025uakt \
            --gas auto \
            --gas-adjustment 1.5 \
            -y

          echo "Waiting for certificate to be committed..."
          sleep 15

          # Verify certificate exists on blockchain
          CERT_COUNT=$(akash query cert list --owner ${{ env.AKASH_ADDRESS }} --node $AKASH_NODE --output json | jq '.certificates | length')
          echo "Certificate count on blockchain: $CERT_COUNT"

      - name: Export certificates as base64
        run: |
          CERT_PATH="$HOME/.akash/certs"

          if [ ! -f "$CERT_PATH/client.crt" ] || [ ! -f "$CERT_PATH/client.key" ]; then
            echo "Error: Certificate files not found"
            exit 1
          fi

          # Create a directory for certificate exports
          EXPORT_DIR="$HOME/cert-export"
          mkdir -p "$EXPORT_DIR"

          # Encode certificates as base64 and save to files (not logs!)
          cat "$CERT_PATH/client.crt" | base64 -w 0 > "$EXPORT_DIR/AKASH_CLIENT_CRT.txt"
          cat "$CERT_PATH/client.key" | base64 -w 0 > "$EXPORT_DIR/AKASH_CLIENT_KEY.txt"

          echo "Certificates encoded and saved to artifact"

          echo "## Certificate Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Certificates have been generated and published to blockchain" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⬇️ **Download the artifact** from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`akash-certificates\` artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the files: \`AKASH_CLIENT_CRT.txt\` and \`AKASH_CLIENT_KEY.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Go to Settings → Secrets and variables → Actions" >> $GITHUB_STEP_SUMMARY
          echo "4. Add new repository secrets:" >> $GITHUB_STEP_SUMMARY
          echo "   - Name: \`AKASH_CLIENT_CRT\`, Value: (contents of AKASH_CLIENT_CRT.txt)" >> $GITHUB_STEP_SUMMARY
          echo "   - Name: \`AKASH_CLIENT_KEY\`, Value: (contents of AKASH_CLIENT_KEY.txt)" >> $GITHUB_STEP_SUMMARY
          echo "5. **Delete the downloaded files** after adding them as secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Security Note**: The artifact will auto-expire in 1 day" >> $GITHUB_STEP_SUMMARY

      - name: Upload certificates as artifact
        uses: actions/upload-artifact@v4
        with:
          name: akash-certificates
          path: ~/cert-export/
          retention-days: 1  # Auto-delete after 1 day for security
          if-no-files-found: error
