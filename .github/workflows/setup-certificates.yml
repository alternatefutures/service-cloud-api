name: Setup Akash Certificates

on:
  workflow_dispatch:

jobs:
  setup-certs:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Install Akash CLI
        run: |
          cd /tmp
          curl -sfL "https://github.com/akash-network/node/releases/download/v1.0.2/akash_1.0.2_linux_amd64.zip" -o akash.zip
          unzip akash.zip
          sudo mv akash /usr/local/bin/
          chmod +x /usr/local/bin/akash
          akash version

      - name: Setup Akash wallet
        env:
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
          AKASH_MNEMONIC: ${{ secrets.AKASH_MNEMONIC }}
        run: |
          echo "$AKASH_MNEMONIC" | akash keys add $AKASH_KEY_NAME --recover --keyring-backend test
          AKASH_ADDRESS=$(akash keys show $AKASH_KEY_NAME -a --keyring-backend test)
          echo "AKASH_ADDRESS=$AKASH_ADDRESS" >> $GITHUB_ENV
          echo "Wallet address: $AKASH_ADDRESS"

      - name: Generate and publish certificate
        env:
          AKASH_NODE: https://rpc.akashnet.net:443
          AKASH_CHAIN_ID: akashnet-2
          AKASH_KEYRING_BACKEND: test
          AKASH_KEY_NAME: deploy
        run: |
          echo "Generating certificate..."
          akash tx cert generate client --from $AKASH_KEY_NAME --keyring-backend test

          echo "Publishing certificate to blockchain..."
          akash tx cert publish client \
            --from $AKASH_KEY_NAME \
            --keyring-backend test \
            --node $AKASH_NODE \
            --chain-id $AKASH_CHAIN_ID \
            --gas-prices 0.025uakt \
            --gas auto \
            --gas-adjustment 1.5 \
            -y

          echo "Waiting for certificate to be committed..."
          sleep 15

          # Verify certificate exists on blockchain
          CERT_COUNT=$(akash query cert list --owner ${{ env.AKASH_ADDRESS }} --node $AKASH_NODE --output json | jq '.certificates | length')
          echo "Certificate count on blockchain: $CERT_COUNT"

      - name: Export certificates as base64
        run: |
          CERT_PATH="$HOME/.akash/certs"

          if [ ! -f "$CERT_PATH/client.crt" ] || [ ! -f "$CERT_PATH/client.key" ]; then
            echo "Error: Certificate files not found"
            exit 1
          fi

          # Encode certificates as base64 for storing in secrets
          CLIENT_CRT_BASE64=$(cat "$CERT_PATH/client.crt" | base64 -w 0)
          CLIENT_KEY_BASE64=$(cat "$CERT_PATH/client.key" | base64 -w 0)

          echo "## Certificate Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add these as GitHub Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AKASH_CLIENT_CRT" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$CLIENT_CRT_BASE64" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AKASH_CLIENT_KEY" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$CLIENT_KEY_BASE64" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Settings → Secrets and variables → Actions" >> $GITHUB_STEP_SUMMARY
          echo "2. Add new repository secrets:" >> $GITHUB_STEP_SUMMARY
          echo "   - Name: \`AKASH_CLIENT_CRT\`, Value: (copy from above)" >> $GITHUB_STEP_SUMMARY
          echo "   - Name: \`AKASH_CLIENT_KEY\`, Value: (copy from above)" >> $GITHUB_STEP_SUMMARY
          echo "3. These certificates will now persist across deployments" >> $GITHUB_STEP_SUMMARY
