#---------------------------------------------------------------------
# AlternateFutures Edge Node - HAProxy Configuration
# Version: 1.0.0
# HAProxy 2.8+
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log stdout format raw local0 info
    maxconn 50000

    # SSL settings
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.3 no-tls-tickets
    ssl-default-server-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Tune for performance
    tune.ssl.default-dh-param 2048
    tune.bufsize 16384
    tune.maxrewrite 1024

    # Stats socket for runtime API
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s

#---------------------------------------------------------------------
# Default settings
#---------------------------------------------------------------------
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    option  http-server-close

    # Timeouts
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s

    # Error handling
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

#---------------------------------------------------------------------
# Stats/monitoring frontend
#---------------------------------------------------------------------
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

    # Prometheus metrics endpoint
    http-request use-service prometheus-exporter if { path /metrics }

#---------------------------------------------------------------------
# HTTP frontend (redirect to HTTPS)
#---------------------------------------------------------------------
frontend http
    bind *:80
    mode http

    # ACME challenge for Let's Encrypt
    acl is_acme path_beg /.well-known/acme-challenge/
    use_backend acme_challenge if is_acme

    # Redirect everything else to HTTPS
    http-request redirect scheme https code 301 unless is_acme

#---------------------------------------------------------------------
# HTTPS frontend (main entry point)
#---------------------------------------------------------------------
frontend https
    bind *:443 ssl crt /etc/haproxy/certs/ alpn h2,http/1.1
    mode http

    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-XSS-Protection "1; mode=block"

    # Request ID for tracing
    unique-id-format %{+X}o\ %ci:%cp_%fi:%fp_%Ts_%rt:%pid
    unique-id-header X-Request-ID

    # Logging
    capture request header Host len 64
    capture request header User-Agent len 128

    # Rate limiting (100 req/10s per IP)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # Connection limiting (1000 concurrent per IP)
    stick-table type ip size 100k expire 30s store conn_cur
    http-request track-sc1 src
    http-request deny deny_status 429 if { sc_conn_cur(1) gt 1000 }

    # Route based on Host header using map file
    use_backend %[req.hdr(host),lower,map_dom(/etc/haproxy/maps/domains.map,be_default)]

#---------------------------------------------------------------------
# Backend: AlternateFutures API (Akash)
#---------------------------------------------------------------------
backend be_api
    mode http
    balance roundrobin

    # Health check
    option httpchk GET /health
    http-check expect status 200

    # Backend SSL (Akash uses HTTPS ingress)
    server akash_api cjrdmusuql9e34bevi8mjgj8pg.ingress.europlots.com:443 ssl verify none sni str(cjrdmusuql9e34bevi8mjgj8pg.ingress.europlots.com) check inter 10s fall 3 rise 2

    # Headers to backend
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Host %[req.hdr(host)]

    # Retry on connection failure
    retries 3
    option redispatch

#---------------------------------------------------------------------
# Backend: AlternateFutures Auth (Akash)
#---------------------------------------------------------------------
backend be_auth
    mode http
    balance roundrobin

    # Health check
    option httpchk GET /health
    http-check expect status 200

    # Backend SSL
    server akash_auth uilm2birnle5b7ffcqvsgpolc4.ingress.europlots.com:443 ssl verify none sni str(uilm2birnle5b7ffcqvsgpolc4.ingress.europlots.com) check inter 10s fall 3 rise 2

    # Headers to backend
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Host %[req.hdr(host)]

    # Retry on connection failure
    retries 3
    option redispatch

#---------------------------------------------------------------------
# Backend: Default (404 handler)
#---------------------------------------------------------------------
backend be_default
    mode http
    http-request deny deny_status 404

#---------------------------------------------------------------------
# Backend: ACME Challenge (for cert renewal)
#---------------------------------------------------------------------
backend acme_challenge
    mode http
    server acme 127.0.0.1:8080
